stages:
  - test
  - docker
  - staging

test:
  image: nextbillionai/nbroutes-test:20201014
  stage: test
  script:
    - cargo test

docker-publish:
  image: nextbillionai/cicd:0.1.0
  stage: docker
  services:
    - docker:18.09-dind

  before_script:
    - docker login -u nextbillionai -p $DOCKER_HUB_PASSWD
    - cat $GCR_AUTH_FILE | docker login -u _json_key --password-stdin asia-docker.pkg.dev
  script:
    - set -e
    - bash .docker.sh
  only:
    - tags
